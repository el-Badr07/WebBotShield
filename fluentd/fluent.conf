# Fluentd configuration for WebBotShield
# Monitors Nginx logs and forwards to Kafka

<source>
  @type tail
  path /logs/nginx/access.log
  pos_file /tmp/access.log.pos
  tag nginx.access
  read_from_head true

  <parse>
    @type regexp
    # Extended nginx format with protocol, port, request_type:
    # $remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" protocol=$protocol port=$port request_type=$request_type
    expression /^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?(?:\s+protocol=(?<protocol>[^\s]+)\s+port=(?<port>\d+)\s+request_type=(?<request_type>[^\s]+))?$/
    time_format %d/%b/%Y:%H:%M:%S %z
  </parse>
</source>

# Add timestamp and enrich log entry
<filter nginx.access>
  @type record_transformer
  enable_ruby true

  <record>
    timestamp ${time.strftime('%Y-%m-%dT%H:%M:%S.%LZ')}
    client_ip ${record["remote"]}
    method ${record["method"]}
    path ${record["path"]}
    status ${record["code"].to_i}
    bytes_sent ${record["size"].to_i}
    user_agent ${record["agent"]}
    referer ${record["referer"]}
    protocol ${record["protocol"] || "TCP"}
    port ${(record["port"] || "80").to_i}
    request_type ${record["request_type"] || "HTTP"}
    log_type "nginx_access"
  </record>

  remove_keys remote,user,method,path,code,size,agent,referer,host
</filter>

# Output to Kafka topic
<match nginx.access>
  @type kafka2

  # Kafka broker configuration
  brokers kafka:9092
  use_event_time true

  # Topic name - must be specified at top level
  topic_key topic
  default_topic nginx-logs

  # Format as JSON
  <format>
    @type json
  </format>

  # Buffer configuration for reliability
  <buffer topic>
    @type file
    path /tmp/fluentd-buffers/kafka.buffer
    flush_mode interval
    flush_interval 3s
    flush_at_shutdown true
    retry_type exponential_backoff
    retry_wait 1s
    retry_max_interval 60s
    retry_timeout 60m
  </buffer>

  # Required configuration
  required_acks -1
  compression_codec gzip
</match>
